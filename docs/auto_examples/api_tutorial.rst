
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "auto_examples/api_tutorial.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        Click :ref:`here <sphx_glr_download_auto_examples_api_tutorial.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_auto_examples_api_tutorial.py:


Introductory example - using the API
====================================

This small tutorial walks through the basics of using an API.
The most basic thing to do is submit a job to the API,
list, get statuses, cancel. We can use our example client for this.

.. GENERATED FROM PYTHON SOURCE LINES 10-31

.. code-block:: default


    import json
    import os
    import sys
    import matplotlib.pyplot as plt

    # This is expected to be rendered from docs root
    here = os.path.dirname(os.path.abspath(os.getcwd()))
    root = os.path.dirname(here)

    # This is here for the nice thumbnail :)
    image = plt.imread(os.path.join(here, "images", "logo.png"))
    fig = plt.imshow(image)
    plt.axis('off')
    plt.show()

    # This directory has the Python client
    sys.path.insert(0, os.path.join(root, "examples"))

    from flux_restful_client import FluxRestfulClient  # noqa




.. image-sg:: /auto_examples/images/sphx_glr_api_tutorial_001.png
   :alt: api tutorial
   :srcset: /auto_examples/images/sphx_glr_api_tutorial_001.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 32-35

Here we instantiate a client. If you need authentication, this can optionally take
a user and token, or also derive from the FLUX_USER and FLUX_TOKEN in the
environment.

.. GENERATED FROM PYTHON SOURCE LINES 35-38

.. code-block:: default


    cli = FluxRestfulClient()








.. GENERATED FROM PYTHON SOURCE LINES 39-40

Let's list the nodes in our cluster!

.. GENERATED FROM PYTHON SOURCE LINES 40-46

.. code-block:: default

    print("Listing nodes")
    res = cli.list_nodes();
    if res:
        print(json.dumps(res, indent=4))






.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Listing nodes
    {}
    {
        "nodes": [
            "a6856cb188a9"
        ]
    }




.. GENERATED FROM PYTHON SOURCE LINES 47-48

Now let's submit a job to Flux.

.. GENERATED FROM PYTHON SOURCE LINES 48-57

.. code-block:: default


    print("üò¥ Submitting job sleep 60")
    res = cli.submit(command=["sleep", 60]);

    # This is an indication something went wrong - detail has an error.
    if res and "detail" in res:
        print(res['detail']);
        sys.exit();





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    üò¥ Submitting job sleep 60
    {}




.. GENERATED FROM PYTHON SOURCE LINES 58-64

To require auth, the server should be startup with these variables
in the environment (and the first two found by the client here)
variables exported:
FLUX_USER=fluxuser
FLUX_TOKEN=12345
FLUX_REQUIRE_AUTH=true

.. GENERATED FROM PYTHON SOURCE LINES 66-67

And finally, let's get job info.

.. GENERATED FROM PYTHON SOURCE LINES 67-72

.. code-block:: default

    print("üçì Getting job info...")
    res = cli.jobs(res["id"]);
    if res:
        print(json.dumps(res, indent=4))





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    üçì Getting job info...
    {}
    {
        "job": {
            "id": 24466415419392,
            "userid": 0,
            "urgency": 16,
            "priority": 16,
            "t_submit": 1667781617.2412803,
            "t_depend": 1667781617.2412803,
            "t_run": 1667781617.2555447,
            "state": 16,
            "name": "sleep",
            "ntasks": 1,
            "ncores": 1,
            "duration": 0.0,
            "nnodes": 1,
            "ranks": "0",
            "nodelist": "a6856cb188a9",
            "expiration": 4821381617.0
        }
    }




.. GENERATED FROM PYTHON SOURCE LINES 73-75

Now let's submit three jobs in unison so we can list them back!
Submit the job to flux

.. GENERATED FROM PYTHON SOURCE LINES 75-82

.. code-block:: default

    print("Submitting 3 jobs to sleep!")
    for time in [10, 20, 30]:
        cli.submit(command=["sleep", time]);
    res = cli.jobs();
    if res:
        print(json.dumps(res, indent=4))





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Submitting 3 jobs to sleep!
    {}
    {}
    {}
    {}
    {
        "jobs": [
            {
                "id": 24468630011904
            },
            {
                "id": 24467992477696
            },
            {
                "id": 24467136839680
            },
            {
                "id": 24466415419392
            },
            {
                "id": 19772888580096
            },
            {
                "id": 19774398529536
            },
            {
                "id": 19773911990272
            },
            {
                "id": 19773425451008
            },
            {
                "id": 19775019286528
            },
            {
                "id": 12969610051584
            },
            {
                "id": 12971103223808
            },
            {
                "id": 12970599907328
            },
            {
                "id": 12970130145280
            },
            {
                "id": 12971740758016
            },
            {
                "id": 11126901309440
            },
            {
                "id": 11128327372800
            },
            {
                "id": 11127857610752
            },
            {
                "id": 11127421403136
            },
            {
                "id": 11128998461440
            },
            {
                "id": 5668031430656
            },
            {
                "id": 5669742706688
            },
            {
                "id": 5669205835776
            },
            {
                "id": 5668652187648
            },
            {
                "id": 5670447349760
            },
            {
                "id": 3678102618112
            },
            {
                "id": 3679629344768
            },
            {
                "id": 3679109251072
            },
            {
                "id": 3678639489024
            },
            {
                "id": 3680250101760
            }
        ]
    }




.. GENERATED FROM PYTHON SOURCE LINES 83-84

Finally, let's submit and cancel a job

.. GENERATED FROM PYTHON SOURCE LINES 84-92

.. code-block:: default

    print("Submitting job sleep 60 intending to cancel..")
    res = cli.submit(command=["sleep", 60]);
    if res:
        print(json.dumps(res, indent=4))
        print("Requesting job cancel..")
        res = cli.cancel(res["id"]);
        print(json.dumps(res, indent=4))





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Submitting job sleep 60 intending to cancel..
    {}
    {
        "Message": "Job submit.",
        "id": 24469485649920
    }
    Requesting job cancel..
    {}
    {
        "Message": "Job is requested to cancel."
    }




.. GENERATED FROM PYTHON SOURCE LINES 93-94

And this would be how you stop your cluster service

.. GENERATED FROM PYTHON SOURCE LINES 94-95

.. code-block:: default

    print("Stopping the service...")
    # res = cli.stop_service()



.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Stopping the service...





.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 0 minutes  0.577 seconds)


.. _sphx_glr_download_auto_examples_api_tutorial.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example


    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: api_tutorial.py <api_tutorial.py>`

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: api_tutorial.ipynb <api_tutorial.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
